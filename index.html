<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CamDraw Air, cámara + puntos de mano</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8eef6; --muted:#98a2b3 }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:#0b0f14; color:var(--fg); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px}
    .stage{position:relative; background:#000; border-radius:12px; overflow:hidden; aspect-ratio:16/9}
    video,canvas{position:absolute; inset:0; width:100%; height:100%}
    video{transform:scaleX(-1)}
    .panel{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    button,select{padding:10px 12px; border-radius:10px; border:1px solid #394150; background:#0f172a; color:#e5e7eb; cursor:pointer}
    .row{display:flex; gap:8px; align-items:center}
    .log{background:#0f172a; border:1px solid #394150; border-radius:10px; padding:10px; min-height:44px; font-size:12px; color:var(--muted)}
    .ok{color:#a7f3d0}
    .err{color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cámara + puntos de mano</h1>
    <div class="stage">
      <video id="cam" playsinline autoplay muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="panel">
      <div class="row">
        <button id="refresh">Listar cámaras</button>
        <select id="device"></select>
      </div>
      <div class="row">
        <button id="start">Iniciar cámara</button>
        <button id="stop">Detener</button>
        <button id="draw">Dibujar con mouse</button>
        <button id="clear">Limpiar dibujo</button>
        <button id="load">Cargar detector</button>
      </div>
    </div>
    <div id="log" class="log">Listo</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.js"></script>
  <script>
    const video = document.getElementById('cam')
    const overlay = document.getElementById('overlay')
    const refreshBtn = document.getElementById('refresh')
    const startBtn = document.getElementById('start')
    const stopBtn = document.getElementById('stop')
    const drawBtn = document.getElementById('draw')
    const clearBtn = document.getElementById('clear')
    const deviceSel = document.getElementById('device')
    const loadBtn = document.getElementById('load')
    const logEl = document.getElementById('log')

    let stream = null
    let drawMode = false
    let drawing = false
    let landmarker = null
    let running = false

    function log(t, cls=''){ logEl.textContent = t; logEl.className = 'log ' + cls }

    function resize(){ overlay.width = overlay.clientWidth; overlay.height = overlay.clientHeight }
    window.addEventListener('resize', resize)
    resize()

    async function enumerateCams(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices()
        const cams = devices.filter(d=>d.kind==='videoinput')
        deviceSel.innerHTML = ''
        cams.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Cámara ${i+1}`; deviceSel.appendChild(o) })
        if (!cams.length) log('Sin cámaras disponibles', 'err')
        else log('Cámaras listadas', 'ok')
      }catch(e){ log('No se pueden listar cámaras, ' + e.message, 'err') }
    }

    async function startCam(){
      try{
        if (stream) return
        const deviceId = deviceSel.value || undefined
        const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'user' }, audio:false }
        stream = await navigator.mediaDevices.getUserMedia(constraints)
        video.srcObject = stream
        await video.play().catch(()=>{})
        log('Cámara iniciada', 'ok')
        running = true
        requestAnimationFrame(loop)
      }catch(e){ log('Fallo al iniciar cámara, ' + e.name + ' ' + e.message, 'err') }
    }

    function stopCam(){
      running = false
      if (!stream) return
      stream.getTracks().forEach(t=>t.stop())
      stream = null
      video.srcObject = null
      const ctx = overlay.getContext('2d')
      ctx.clearRect(0,0,overlay.width,overlay.height)
      log('Cámara detenida')
    }

    // Dibujo con mouse para validar el canvas
    const ctx = overlay.getContext('2d')
    ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 6
    overlay.addEventListener('pointerdown', e=>{ if(!drawMode) return; drawing=true; const r=overlay.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left, e.clientY-r.top) })
    overlay.addEventListener('pointermove', e=>{ if(!drawMode||!drawing) return; const r=overlay.getBoundingClientRect(); ctx.lineTo(e.clientX-r.left, e.clientY-r.top); ctx.stroke() })
    overlay.addEventListener('pointerup', ()=>{ drawing=false })
    overlay.addEventListener('pointerleave', ()=>{ drawing=false })

    refreshBtn.addEventListener('click', enumerateCams)
    startBtn.addEventListener('click', startCam)
    stopBtn.addEventListener('click', stopCam)
    drawBtn.addEventListener('click', ()=>{ drawMode = !drawMode; log(drawMode? 'Dibujo con mouse activo' : 'Dibujo con mouse inactivo', drawMode? 'ok' : '') })
    clearBtn.addEventListener('click', ()=> ctx.clearRect(0,0,overlay.width,overlay.height))

    // Cargar solo el detector y dibujar puntos, sin gestos
    async function loadDetector(){
      try{
        log('Cargando detector...')
        const fs = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm')
        landmarker = await HandLandmarker.createFromOptions(fs, {
          baseOptions: { modelAssetPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm/hand_landmarker.task' },
          numHands: 1,
          runningMode: 'VIDEO'
        })
        log('Detector listo', 'ok')
      }catch(e){ log('Error al cargar detector, ' + e.message, 'err') }
    }

    loadBtn.addEventListener('click', loadDetector)

    function loop(){
      if (!running) return
      const w = overlay.width, h = overlay.height
      ctx.clearRect(0,0,w,h)

      if (landmarker){
        const now = performance.now()
        const results = landmarker.detectForVideo(video, now)
        if (results && results.landmarks && results.landmarks.length){
          const lms = results.landmarks[0]
          ctx.fillStyle = '#a5b4fc'
          for (const p of lms){ const x = (1 - p.x) * w; const y = p.y * h; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill() }
        }
      }
      requestAnimationFrame(loop)
    }

    if (!location.protocol.startsWith('https')) log('Abre en HTTPS', 'err')
    if (!navigator.mediaDevices) log('API mediaDevices no disponible', 'err')

    enumerateCams()
  </script>
</body>
</html>
